// Prisma schema for XChatLife
// Extends Better Auth with chatbot application models

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

// User Enums
enum Language {
  english
  german
  french
  spanish
}

enum UserRole {
  default
  admin
  superadmin
}

// Character Enums
enum CharacterGender {
  girl
  men
  trans
}

enum CharacterStyle {
  realistic
  anime
}

enum Ethnicity {
  caucasian
  asian
  black
  latina
  arab
}

enum HairStyle {
  straight
  bangs
  curly
  bun
  short
  ponytail
}

enum HairColor {
  brunette
  blonde
  black
  redhead
  pink
}

enum EyeColor {
  brown
  blue
  green
}

enum BodyType {
  skinny
  athletic
  average
  curvy
  bbw
}

enum BreastSize {
  small
  medium
  large
  extra_large
}

enum Personality {
  nympho
  lover
  submissive
  dominant
  temptress
  innocent
  caregiver
  experimenter
  mean
  confidant
  shy
  queen
}

enum Relationship {
  stranger
  girlfriend
  sex_friend
  school_mate
  work_colleague
  wife
  mistress
  friend
  step_sister
  step_mom
}

enum Occupation {
  student
  dancer
  model
  stripper
  maid
  cam_girl
  boss
  babysitter
  pornstar
  streamer
  bartender
  tech_engineer
  lifeguard
  cashier
  massage_therapist
  teacher
  nurse
  secretary
  yoga_instructor
  fitness_coach
}

enum Kink {
  daddy_dominance
  bondage
  spanking
  collar_leash
  punishment
  humiliation
  public_play
  roleplay
  anal_play
  oral_play
  cum_play
  creampie
  squirting
  dirty_talk
  breeding
  edging
  obedience
  control
  inexperienced
  shy_flirting
  playful_teasing
  cuddling
  slow_sensual
  hair_pulling
}

// Message & Media Enums
enum MessageType {
  text
  image
  video
  audio
}

enum MediaType {
  image
  video
}

// Subscription & Affiliate Enums
enum BillingCycle {
  monthly
  quarterly
  annually
}

enum SubscriptionStatus {
  active
  cancelled
  expired
  pending
}

enum ReferralStatus {
  pending
  converted
  paid
}

// ============================================================================
// MODELS
// ============================================================================

// Legacy Post model (can be removed if not needed)
model Post {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  createdBy   User   @relation(fields: [createdById], references: [id])
  createdById String

  @@index([name])
}

// User - Extended Better Auth model
model User {
  // Existing Better Auth fields
  id            String   @id
  name          String
  email         String   @unique
  emailVerified Boolean  @default(false)
  image         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @default(now()) @updatedAt

  // Extended fields
  avatar        String?
  nickname      String?
  gender        String?
  language      Language @default(english)
  notifications Boolean  @default(true)
  role          UserRole @default(default)

  // Relations
  sessions          Session[]
  accounts          Account[]
  posts             Post[]
  createdCharacters Character[]   @relation("CreatedCharacters")
  chats             Chat[]
  collections       Collection[]
  subscription      Subscription?
  usageQuotas       UsageQuota[]
  affiliate         Affiliate?
  referredBy        Referral?     @relation("ReferredUser")

  @@index([role])
  @@index([language])
  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  @@map("verification")
}

// Character - AI characters that users can chat with
model Character {
  id        String   @id @default(cuid())
  name      String

  // Physical attributes
  gender     CharacterGender
  style      CharacterStyle
  ethnicity  Ethnicity
  age        Int
  hairStyle  HairStyle
  hairColor  HairColor
  eyeColor   EyeColor
  bodyType   BodyType
  breastSize BreastSize

  // Personality & behavior
  personality  Personality
  relationship Relationship
  occupation   Occupation
  voice        String

  // Visibility
  isPublic Boolean @default(false)
  isActive Boolean @default(true)

  // Metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   User     @relation("CreatedCharacters", fields: [createdById], references: [id], onDelete: Cascade)
  createdById String

  // Relations
  kinks   CharacterKink[]
  chats   Chat[]
  stories Story[]
  reels   Reel[]

  @@index([createdById])
  @@index([isPublic])
  @@index([gender])
  @@index([style])
  @@index([personality])
  @@index([isActive])
  @@map("character")
}

// CharacterKink - Junction table for many-to-many between characters and kinks
model CharacterKink {
  id          String   @id @default(cuid())
  characterId String
  kink        Kink
  createdAt   DateTime @default(now())

  character Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@unique([characterId, kink])
  @@index([characterId])
  @@index([kink])
  @@map("character_kink")
}

// Chat - 1-to-1 conversation between a user and a character
model Chat {
  id            String    @id @default(cuid())
  userId        String
  characterId   String
  isArchived    Boolean   @default(false)
  lastMessageAt DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  character Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
  messages  Message[]

  @@unique([userId, characterId])
  @@index([userId])
  @@index([characterId])
  @@index([lastMessageAt])
  @@index([isArchived])
  @@map("chat")
}

// Message - Individual messages within a chat
model Message {
  id         String      @id @default(cuid())
  chatId     String
  type       MessageType
  content    String      @db.Text
  isFromUser Boolean
  isDeleted  Boolean     @default(false)
  createdAt  DateTime    @default(now())

  chat       Chat        @relation(fields: [chatId], references: [id], onDelete: Cascade)
  collection Collection?

  @@index([chatId])
  @@index([createdAt])
  @@index([isFromUser])
  @@map("message")
}

// Collection - Saved images from chats
model Collection {
  id        String   @id @default(cuid())
  userId    String
  messageId String?  @unique
  url       String
  key       String
  createdAt DateTime @default(now())

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  message Message? @relation(fields: [messageId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([createdAt])
  @@map("collection")
}

// Subscription - Premium subscription via CoinGate
model Subscription {
  id                 String             @id @default(cuid())
  userId             String             @unique
  billingCycle       BillingCycle
  status             SubscriptionStatus
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  coinGateOrderId    String?
  cancelledAt        DateTime?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([currentPeriodEnd])
  @@index([coinGateOrderId])
  @@map("subscription")
}

// UsageQuota - Track token and resource usage per billing period
model UsageQuota {
  id              String   @id @default(cuid())
  userId          String
  periodStart     DateTime
  periodEnd       DateTime
  tokensUsed      Int      @default(0)
  tokensLimit     Int
  messagesUsed    Int      @default(0)
  imagesGenerated Int      @default(0)
  videosGenerated Int      @default(0)
  audiosGenerated Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, periodStart, periodEnd])
  @@index([userId])
  @@index([periodEnd])
  @@map("usage_quota")
}

// Story - Character stories (24-hour expiry like Instagram)
model Story {
  id           String    @id @default(cuid())
  characterId  String
  mediaType    MediaType
  mediaUrl     String
  thumbnailUrl String?
  expiresAt    DateTime
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())

  character Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@index([characterId])
  @@index([expiresAt])
  @@index([isActive])
  @@map("story")
}

// Reel - Character video reels (permanent, admin-managed content)
model Reel {
  id           String   @id @default(cuid())
  characterId  String
  videoUrl     String
  thumbnailUrl String?
  title        String?
  description  String?
  viewCount    Int      @default(0)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  character Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@index([characterId])
  @@index([isActive])
  @@index([createdAt])
  @@map("reel")
}

// Affiliate - User affiliate accounts for referral program
model Affiliate {
  id             String   @id @default(cuid())
  userId         String   @unique
  referralCode   String   @unique
  commissionRate Decimal  @db.Decimal(5, 4)
  totalEarned    Decimal  @default(0) @db.Decimal(10, 2)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  referrals Referral[]

  @@index([referralCode])
  @@index([isActive])
  @@map("affiliate")
}

// Referral - Tracks referred users and their conversion status
model Referral {
  id             String         @id @default(cuid())
  affiliateId    String
  referredUserId String         @unique
  status         ReferralStatus @default(pending)
  commission     Decimal        @default(0) @db.Decimal(10, 2)
  convertedAt    DateTime?
  paidAt         DateTime?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  affiliate    Affiliate @relation(fields: [affiliateId], references: [id], onDelete: Cascade)
  referredUser User      @relation("ReferredUser", fields: [referredUserId], references: [id], onDelete: Cascade)

  @@index([affiliateId])
  @@index([status])
  @@map("referral")
}
