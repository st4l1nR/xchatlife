generator client {
  provider        = "prisma-client-js"
  output          = "../generated/prisma"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [pgvector(map: "vector", schema: "public")]
}

model Post {
  id          String   @id @default(cuid())
  name        String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String
  user        user     @relation(fields: [createdById], references: [id])

  @@index([name])
}

model account {
  id                    String    @id @default(cuid())
  accountId             String
  providerId            String
  userId                String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  user                  user      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ==========================================
// AFFILIATE ENUMS
// ==========================================

enum AffiliateStatus {
  pending
  approved
  rejected
}

enum AffiliateType {
  influencer
  blogger
  youtuber
  social_media
  website_owner
  email_marketing
  other
}

model affiliate {
  id                 String          @id @default(cuid())
  userId             String          @unique

  // Application fields
  firstName          String?
  email              String
  websiteUrl         String
  telegram           String?
  type               AffiliateType
  introduction       String?         @db.Text
  promotionalMethods String?         @db.Text
  status             AffiliateStatus @default(pending)
  rejectionReason    String?         @db.Text

  // Approved affiliate fields (nullable until approved)
  referralCode       String?         @unique
  commissionRate     Decimal?        @db.Decimal(5, 4)
  totalEarned        Decimal         @default(0) @db.Decimal(10, 2)
  isActive           Boolean         @default(false)

  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  approvedAt         DateTime?

  user                  user                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  referral              referral[]
  financial_transaction financial_transaction[]

  @@index([status])
  @@index([isActive])
  @@index([referralCode])
}

// ==========================================
// CHARACTER GENDER & STYLE
// ==========================================

model character_gender {
  id          String   @id @default(cuid())
  name        String   @unique // "girl", "men", "trans"
  label       String // Display name e.g., "Girl", "Men", "Trans"
  title       String?
  description String?
  emoji       String? // e.g., "üë©", "üë®", "‚ößÔ∏è"
  imageId     String?
  videoId     String?
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  image              media?              @relation("gender_image", fields: [imageId], references: [id])
  video              media?              @relation("gender_video", fields: [videoId], references: [id])
  characters         character[]
  character_variants character_variant[]

  // Relations to option tables
  ethnicities   character_ethnicity[]
  hairStyles    character_hair_style[]
  hairColors    character_hair_color[]
  eyeColors     character_eye_color[]
  bodyTypes     character_body_type[]
  breastSizes   character_breast_size[]
  personalities character_personality[]
  relationships character_relationship[]
  occupations   character_occupation[]

  @@index([isActive])
  @@index([sortOrder])
  @@index([imageId])
  @@index([videoId])
}

model character_style {
  id          String   @id @default(cuid())
  name        String   @unique // "realistic", "anime"
  label       String // Display name e.g., "Realistic", "Anime"
  title       String?
  description String?
  emoji       String?
  imageId     String?
  videoId     String?
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  image              media?              @relation("style_image", fields: [imageId], references: [id])
  video              media?              @relation("style_video", fields: [videoId], references: [id])
  characters         character[]
  character_variants character_variant[]

  // Relations to option tables
  ethnicities   character_ethnicity[]
  hairStyles    character_hair_style[]
  hairColors    character_hair_color[]
  eyeColors     character_eye_color[]
  bodyTypes     character_body_type[]
  breastSizes   character_breast_size[]
  personalities character_personality[]
  relationships character_relationship[]
  occupations   character_occupation[]

  @@index([isActive])
  @@index([sortOrder])
  @@index([imageId])
  @@index([videoId])
}

// ==========================================
// CHARACTER VARIANT (intersection of gender + style)
// ==========================================

model character_variant {
  id          String   @id @default(cuid())
  genderId    String
  styleId     String
  name        String   @unique // "girl-realistic", "girl-anime", etc.
  label       String   @default("")
  title       String?
  description String?
  emoji       String?
  imageId     String?
  videoId     String?
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  gender character_gender @relation(fields: [genderId], references: [id])
  style  character_style  @relation(fields: [styleId], references: [id])
  image  media?           @relation("variant_image", fields: [imageId], references: [id])
  video  media?           @relation("variant_video", fields: [videoId], references: [id])

  @@unique([genderId, styleId])
  @@index([isActive])
  @@index([imageId])
  @@index([videoId])
  @@index([genderId])
  @@index([styleId])
}

// ==========================================
// CHARACTER OPTION TABLES
// ==========================================

model character_ethnicity {
  id          String   @id @default(cuid())
  name        String
  label       String
  title       String?
  description String?
  emoji       String?
  genderId    String
  styleId     String
  imageId     String?
  videoId     String?
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  gender    character_gender @relation(fields: [genderId], references: [id])
  style     character_style  @relation(fields: [styleId], references: [id])
  image     media?           @relation("ethnicity_image", fields: [imageId], references: [id])
  video     media?           @relation("ethnicity_video", fields: [videoId], references: [id])
  character character[]

  @@unique([name, genderId, styleId])
  @@index([genderId])
  @@index([styleId])
  @@index([isActive])
  @@index([sortOrder])
  @@index([imageId])
  @@index([videoId])
}

model character_hair_style {
  id          String   @id @default(cuid())
  name        String
  label       String
  title       String?
  description String?
  emoji       String?
  genderId    String
  styleId     String
  imageId     String?
  videoId     String?
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  gender    character_gender @relation(fields: [genderId], references: [id])
  style     character_style  @relation(fields: [styleId], references: [id])
  image     media?           @relation("hair_style_image", fields: [imageId], references: [id])
  video     media?           @relation("hair_style_video", fields: [videoId], references: [id])
  character character[]

  @@unique([name, genderId, styleId])
  @@index([genderId])
  @@index([styleId])
  @@index([isActive])
  @@index([sortOrder])
  @@index([imageId])
  @@index([videoId])
}

model character_hair_color {
  id          String   @id @default(cuid())
  name        String
  label       String
  title       String?
  description String?
  emoji       String?
  genderId    String
  styleId     String
  imageId     String?
  videoId     String?
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  gender    character_gender @relation(fields: [genderId], references: [id])
  style     character_style  @relation(fields: [styleId], references: [id])
  image     media?           @relation("hair_color_image", fields: [imageId], references: [id])
  video     media?           @relation("hair_color_video", fields: [videoId], references: [id])
  character character[]

  @@unique([name, genderId, styleId])
  @@index([genderId])
  @@index([styleId])
  @@index([isActive])
  @@index([sortOrder])
  @@index([imageId])
  @@index([videoId])
}

model character_eye_color {
  id          String   @id @default(cuid())
  name        String
  label       String
  title       String?
  description String?
  emoji       String?
  genderId    String
  styleId     String
  imageId     String?
  videoId     String?
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  gender    character_gender @relation(fields: [genderId], references: [id])
  style     character_style  @relation(fields: [styleId], references: [id])
  image     media?           @relation("eye_color_image", fields: [imageId], references: [id])
  video     media?           @relation("eye_color_video", fields: [videoId], references: [id])
  character character[]

  @@unique([name, genderId, styleId])
  @@index([genderId])
  @@index([styleId])
  @@index([isActive])
  @@index([sortOrder])
  @@index([imageId])
  @@index([videoId])
}

model character_body_type {
  id          String   @id @default(cuid())
  name        String
  label       String
  title       String?
  description String?
  emoji       String?
  genderId    String
  styleId     String
  imageId     String?
  videoId     String?
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  gender    character_gender @relation(fields: [genderId], references: [id])
  style     character_style  @relation(fields: [styleId], references: [id])
  image     media?           @relation("body_type_image", fields: [imageId], references: [id])
  video     media?           @relation("body_type_video", fields: [videoId], references: [id])
  character character[]

  @@unique([name, genderId, styleId])
  @@index([genderId])
  @@index([styleId])
  @@index([isActive])
  @@index([sortOrder])
  @@index([imageId])
  @@index([videoId])
}

model character_breast_size {
  id          String   @id @default(cuid())
  name        String
  label       String
  title       String?
  description String?
  emoji       String?
  genderId    String
  styleId     String
  imageId     String?
  videoId     String?
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  gender    character_gender @relation(fields: [genderId], references: [id])
  style     character_style  @relation(fields: [styleId], references: [id])
  image     media?           @relation("breast_size_image", fields: [imageId], references: [id])
  video     media?           @relation("breast_size_video", fields: [videoId], references: [id])
  character character[]

  @@unique([name, genderId, styleId])
  @@index([genderId])
  @@index([styleId])
  @@index([isActive])
  @@index([sortOrder])
  @@index([imageId])
  @@index([videoId])
}

model character_personality {
  id          String   @id @default(cuid())
  name        String
  label       String
  title       String?
  description String?
  emoji       String?
  genderId    String
  styleId     String
  imageId     String?
  videoId     String?
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  gender    character_gender @relation(fields: [genderId], references: [id])
  style     character_style  @relation(fields: [styleId], references: [id])
  image     media?           @relation("personality_image", fields: [imageId], references: [id])
  video     media?           @relation("personality_video", fields: [videoId], references: [id])
  character character[]

  @@unique([name, genderId, styleId])
  @@index([genderId])
  @@index([styleId])
  @@index([isActive])
  @@index([sortOrder])
  @@index([imageId])
  @@index([videoId])
}

model character_relationship {
  id          String   @id @default(cuid())
  name        String
  label       String
  title       String?
  description String?
  emoji       String?
  genderId    String
  styleId     String
  imageId     String?
  videoId     String?
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  gender    character_gender @relation(fields: [genderId], references: [id])
  style     character_style  @relation(fields: [styleId], references: [id])
  image     media?           @relation("relationship_image", fields: [imageId], references: [id])
  video     media?           @relation("relationship_video", fields: [videoId], references: [id])
  character character[]

  @@unique([name, genderId, styleId])
  @@index([genderId])
  @@index([styleId])
  @@index([isActive])
  @@index([sortOrder])
  @@index([imageId])
  @@index([videoId])
}

model character_occupation {
  id          String   @id @default(cuid())
  name        String
  label       String
  title       String?
  description String?
  emoji       String?
  genderId    String
  styleId     String
  imageId     String?
  videoId     String?
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  gender    character_gender @relation(fields: [genderId], references: [id])
  style     character_style  @relation(fields: [styleId], references: [id])
  image     media?           @relation("occupation_image", fields: [imageId], references: [id])
  video     media?           @relation("occupation_video", fields: [videoId], references: [id])
  character character[]

  @@unique([name, genderId, styleId])
  @@index([genderId])
  @@index([styleId])
  @@index([isActive])
  @@index([sortOrder])
  @@index([imageId])
  @@index([videoId])
}

// ==========================================
// CHARACTER MODELS
// ==========================================

model character {
  id             String   @id @default(cuid())
  name           String
  avatarId       String?
  posterId       String?
  videoId        String?
  genderId       String
  styleId        String
  age            Int
  voice          String
  isPublic       Boolean  @default(false)
  isActive       Boolean  @default(true)
  isLive         Boolean  @default(false)
  chatCount      Int      @default(0)
  likeCount      Int      @default(0)
  messageCount   Int      @default(0)
  viewCount      Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  createdById    String
  // Foreign keys for option tables
  ethnicityId    String
  personalityId  String
  hairStyleId    String
  hairColorId    String
  eyeColorId     String
  bodyTypeId     String
  breastSizeId   String
  occupationId   String
  relationshipId String

  // Relations
  user                           user                     @relation(fields: [createdById], references: [id], onDelete: Cascade)
  avatar                         media?                   @relation("character_avatarIdTomedia", fields: [avatarId], references: [id])
  poster                         media?                   @relation("character_posterIdTomedia", fields: [posterId], references: [id])
  video                          media?                   @relation("character_videoIdTomedia", fields: [videoId], references: [id])
  gender                         character_gender         @relation(fields: [genderId], references: [id])
  style                          character_style          @relation(fields: [styleId], references: [id])
  ethnicity                      character_ethnicity      @relation(fields: [ethnicityId], references: [id])
  personality                    character_personality    @relation(fields: [personalityId], references: [id])
  hairStyle                      character_hair_style     @relation(fields: [hairStyleId], references: [id])
  hairColor                      character_hair_color     @relation(fields: [hairColorId], references: [id])
  eyeColor                       character_eye_color      @relation(fields: [eyeColorId], references: [id])
  bodyType                       character_body_type      @relation(fields: [bodyTypeId], references: [id])
  breastSize                     character_breast_size    @relation(fields: [breastSizeId], references: [id])
  occupation                     character_occupation     @relation(fields: [occupationId], references: [id])
  relationship                   character_relationship   @relation(fields: [relationshipId], references: [id])
  character_image                character_image[]
  chat                           chat[]
  reel                           reel[]
  story                          story[]
  private_content                private_content[]
  media                          media[]                  @relation("media_characterId")
  visual_novel_character         visual_novel_character[]
  visual_novel_node              visual_novel_node[]

  @@index([createdById])
  @@index([genderId])
  @@index([isActive])
  @@index([isPublic])
  @@index([styleId])
  @@index([ethnicityId])
  @@index([personalityId])
  @@index([hairStyleId])
  @@index([hairColorId])
  @@index([eyeColorId])
  @@index([bodyTypeId])
  @@index([breastSizeId])
  @@index([occupationId])
  @@index([relationshipId])
}

model character_image {
  id                String   @id @default(cuid())
  userId            String
  characterId       String
  mediaId           String
  prompt            String
  canConvertToVideo Boolean  @default(false)
  createdAt         DateTime @default(now())

  user      user      @relation(fields: [userId], references: [id], onDelete: Cascade)
  character character @relation(fields: [characterId], references: [id], onDelete: Cascade)
  media     media     @relation(fields: [mediaId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([characterId])
  @@index([createdAt])
}

// ==========================================
// CHAT & MESSAGING MODELS
// ==========================================

model chat {
  id                String              @id @default(cuid())
  userId            String
  characterId       String
  isArchived        Boolean             @default(false)
  lastMessageAt     DateTime?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  character         character           @relation(fields: [characterId], references: [id], onDelete: Cascade)
  user              user                @relation(fields: [userId], references: [id], onDelete: Cascade)
  message           message[]
  message_embedding message_embedding[]

  @@unique([userId, characterId])
  @@index([characterId])
  @@index([isArchived])
  @@index([lastMessageAt])
  @@index([userId])
}

model collection {
  id        String   @id @default(cuid())
  userId    String
  messageId String?  @unique
  mediaId   String
  createdAt DateTime @default(now())
  media     media    @relation(fields: [mediaId], references: [id], onDelete: Cascade)
  message   message? @relation(fields: [messageId], references: [id])
  user      user     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([mediaId])
  @@index([userId])
}

model message {
  id                String             @id @default(cuid())
  chatId            String
  type              MessageType
  content           String
  isFromUser        Boolean
  isDeleted         Boolean            @default(false)
  createdAt         DateTime           @default(now())
  collection        collection?
  chat              chat               @relation(fields: [chatId], references: [id], onDelete: Cascade)
  message_embedding message_embedding?

  @@index([chatId])
  @@index([createdAt])
  @@index([isFromUser])
}

model message_embedding {
  id        String                   @id @default(dbgenerated("gen_random_uuid()::text"))
  messageId String                   @unique @map("message_id")
  chatId    String                   @map("chat_id")
  embedding Unsupported("vector")?
  createdAt DateTime                 @default(now()) @map("created_at")
  message   message                  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  chat      chat                     @relation(fields: [chatId], references: [id], onDelete: Cascade)

  @@index([chatId])
}

// ==========================================
// MEDIA LIBRARY SYSTEM
// ==========================================

model media_folder {
  id                 String               @id @default(cuid())
  name               String
  description        String?
  createdById        String
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  createdBy          user                 @relation(fields: [createdById], references: [id], onDelete: Cascade)
  media              media[]
  visual_novel_media visual_novel_media[]

  @@index([createdById])
  @@index([name])
}

model media {
  id                                  String                @id @default(cuid())
  type                                MediaType
  key                                 String                @unique
  url                                 String
  mimeType                            String?
  size                                Int?
  width                               Int?
  height                              Int?
  duration                            Int?
  category                            MediaCategory         @default(other)
  folderId                            String?
  characterId                         String?
  createdAt                           DateTime              @default(now())
  folder                              media_folder?         @relation(fields: [folderId], references: [id], onDelete: SetNull)
  character                           character?            @relation("media_characterId", fields: [characterId], references: [id], onDelete: SetNull)
  character_character_avatarIdTomedia character[]           @relation("character_avatarIdTomedia")
  character_character_posterIdTomedia character[]           @relation("character_posterIdTomedia")
  character_character_videoIdTomedia  character[]           @relation("character_videoIdTomedia")
  variant_image                       character_variant[]   @relation("variant_image")
  variant_video                       character_variant[]   @relation("variant_video")

  // Option table relations
  gender_image       character_gender[]       @relation("gender_image")
  gender_video       character_gender[]       @relation("gender_video")
  style_image        character_style[]        @relation("style_image")
  style_video        character_style[]        @relation("style_video")
  ethnicity_image    character_ethnicity[]    @relation("ethnicity_image")
  ethnicity_video    character_ethnicity[]    @relation("ethnicity_video")
  hair_style_image   character_hair_style[]   @relation("hair_style_image")
  hair_style_video   character_hair_style[]   @relation("hair_style_video")
  hair_color_image   character_hair_color[]   @relation("hair_color_image")
  hair_color_video   character_hair_color[]   @relation("hair_color_video")
  eye_color_image    character_eye_color[]    @relation("eye_color_image")
  eye_color_video    character_eye_color[]    @relation("eye_color_video")
  body_type_image    character_body_type[]    @relation("body_type_image")
  body_type_video    character_body_type[]    @relation("body_type_video")
  breast_size_image  character_breast_size[]  @relation("breast_size_image")
  breast_size_video  character_breast_size[]  @relation("breast_size_video")
  personality_image  character_personality[]  @relation("personality_image")
  personality_video  character_personality[]  @relation("personality_video")
  relationship_image character_relationship[] @relation("relationship_image")
  relationship_video character_relationship[] @relation("relationship_video")
  occupation_image   character_occupation[]   @relation("occupation_image")
  occupation_video   character_occupation[]   @relation("occupation_video")

  character_image                     character_image[]
  collection                          collection[]
  reel_reel_thumbnailIdTomedia        reel[]                @relation("reel_thumbnailIdTomedia")
  reel_reel_videoIdTomedia            reel[]                @relation("reel_videoIdTomedia")
  story_story_mediaIdTomedia          story[]               @relation("story_mediaIdTomedia")
  story_story_thumbnailIdTomedia      story[]               @relation("story_thumbnailIdTomedia")
  private_content_poster              private_content[]     @relation("private_content_poster")
  private_content_media               private_content_media[]
  visual_novel_thumbnail              visual_novel[]        @relation("visual_novel_thumbnail")
  node_scenery                        visual_novel_node[]   @relation("node_scenery")
  node_character_image                visual_novel_node[]   @relation("node_character_image")
  node_music                          visual_novel_node[]   @relation("node_music")
  visual_novel_media                  visual_novel_media[]

  @@index([createdAt])
  @@index([type])
  @@index([folderId])
  @@index([characterId])
  @@index([category])
}

// ==========================================
// CONTENT MODELS (Reels, Stories)
// ==========================================

model reel {
  id          String    @id @default(cuid())
  characterId String
  videoId     String
  thumbnailId String?
  title       String?
  description String?
  sortOrder   Int       @default(0)
  viewCount   Int       @default(0)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  character   character @relation(fields: [characterId], references: [id], onDelete: Cascade)
  thumbnail   media?    @relation("reel_thumbnailIdTomedia", fields: [thumbnailId], references: [id])
  video       media     @relation("reel_videoIdTomedia", fields: [videoId], references: [id], onDelete: Cascade)

  @@index([characterId])
  @@index([createdAt])
  @@index([isActive])
  @@index([videoId])
  @@index([sortOrder])
}

model story {
  id          String    @id @default(cuid())
  characterId String
  mediaId     String
  thumbnailId String?
  sortOrder   Int       @default(0)
  expiresAt   DateTime? // Optional for permanent stories
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  character   character @relation(fields: [characterId], references: [id], onDelete: Cascade)
  media       media     @relation("story_mediaIdTomedia", fields: [mediaId], references: [id], onDelete: Cascade)
  thumbnail   media?    @relation("story_thumbnailIdTomedia", fields: [thumbnailId], references: [id])

  @@index([characterId])
  @@index([expiresAt])
  @@index([isActive])
  @@index([mediaId])
  @@index([sortOrder])
}

// ==========================================
// PRIVATE CONTENT MODELS
// ==========================================

model private_content {
  id          String                  @id @default(cuid())
  characterId String
  name        String
  description String?                 @db.Text
  tokenPrice  Int                     @default(0)
  posterId    String?
  sortOrder   Int                     @default(0)
  isActive    Boolean                 @default(true)
  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @updatedAt

  character  character               @relation(fields: [characterId], references: [id], onDelete: Cascade)
  poster     media?                  @relation("private_content_poster", fields: [posterId], references: [id])
  mediaItems private_content_media[]

  @@index([characterId])
  @@index([isActive])
  @@index([sortOrder])
}

model private_content_media {
  id               String          @id @default(cuid())
  privateContentId String
  mediaId          String
  sortOrder        Int             @default(0)
  createdAt        DateTime        @default(now())

  privateContent private_content @relation(fields: [privateContentId], references: [id], onDelete: Cascade)
  media          media           @relation(fields: [mediaId], references: [id], onDelete: Cascade)

  @@index([privateContentId])
  @@index([mediaId])
  @@index([sortOrder])
}

// ==========================================
// VISUAL NOVEL SYSTEM
// ==========================================

model visual_novel {
  id          String                   @id @default(cuid())
  title       String
  description String?
  thumbnailId String?
  isPublished Boolean                  @default(false)
  createdById String
  createdAt   DateTime                 @default(now())
  updatedAt   DateTime                 @updatedAt
  thumbnail   media?                   @relation("visual_novel_thumbnail", fields: [thumbnailId], references: [id])
  createdBy   user                     @relation(fields: [createdById], references: [id], onDelete: Cascade)
  characters  visual_novel_character[]
  nodes       visual_novel_node[]
  edges       visual_novel_edge[]
  media_links visual_novel_media[]

  @@index([createdById])
  @@index([isPublished])
}

model visual_novel_character {
  id            String       @id @default(cuid())
  visualNovelId String
  characterId   String
  createdAt     DateTime     @default(now())
  visualNovel   visual_novel @relation(fields: [visualNovelId], references: [id], onDelete: Cascade)
  character     character    @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@unique([visualNovelId, characterId])
  @@index([visualNovelId])
  @@index([characterId])
}

model visual_novel_node {
  id                String                       @id @default(cuid())
  visualNovelId     String
  type              VisualNovelNodeType
  positionX         Float
  positionY         Float
  // Scene node fields
  characterId       String?
  dialogue          String?
  sceneryImageId    String?
  characterImageId  String?
  backgroundMusicId String?
  // Choice node fields
  promptText        String?
  createdAt         DateTime                     @default(now())
  updatedAt         DateTime                     @updatedAt
  visualNovel       visual_novel                 @relation(fields: [visualNovelId], references: [id], onDelete: Cascade)
  character         character?                   @relation(fields: [characterId], references: [id])
  sceneryImage      media?                       @relation("node_scenery", fields: [sceneryImageId], references: [id])
  characterImage    media?                       @relation("node_character_image", fields: [characterImageId], references: [id])
  backgroundMusic   media?                       @relation("node_music", fields: [backgroundMusicId], references: [id])
  choiceOptions     visual_novel_choice_option[]
  edgesFrom         visual_novel_edge[]          @relation("edge_source")
  edgesTo           visual_novel_edge[]          @relation("edge_target")

  @@index([visualNovelId])
  @@index([type])
}

model visual_novel_choice_option {
  id        String              @id @default(cuid())
  nodeId    String
  text      String
  sortOrder Int                 @default(0)
  createdAt DateTime            @default(now())
  node      visual_novel_node   @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  edges     visual_novel_edge[]

  @@index([nodeId])
  @@index([sortOrder])
}

model visual_novel_edge {
  id             String                      @id @default(cuid())
  visualNovelId  String
  sourceNodeId   String
  targetNodeId   String
  choiceOptionId String?
  createdAt      DateTime                    @default(now())
  visualNovel    visual_novel                @relation(fields: [visualNovelId], references: [id], onDelete: Cascade)
  sourceNode     visual_novel_node           @relation("edge_source", fields: [sourceNodeId], references: [id], onDelete: Cascade)
  targetNode     visual_novel_node           @relation("edge_target", fields: [targetNodeId], references: [id], onDelete: Cascade)
  choiceOption   visual_novel_choice_option? @relation(fields: [choiceOptionId], references: [id], onDelete: Cascade)

  @@unique([sourceNodeId, targetNodeId, choiceOptionId])
  @@index([visualNovelId])
  @@index([sourceNodeId])
  @@index([targetNodeId])
}

model visual_novel_media {
  id            String        @id @default(cuid())
  visualNovelId String
  mediaId       String?
  folderId      String?
  createdAt     DateTime      @default(now())
  visualNovel   visual_novel  @relation(fields: [visualNovelId], references: [id], onDelete: Cascade)
  media         media?        @relation(fields: [mediaId], references: [id], onDelete: Cascade)
  folder        media_folder? @relation(fields: [folderId], references: [id], onDelete: Cascade)

  @@index([visualNovelId])
  @@index([mediaId])
  @@index([folderId])
}

// ==========================================
// SUPPORT TICKETS SYSTEM
// ==========================================

model ticket {
  id           String            @id @default(cuid())
  userId       String
  assignedToId String?
  subject      String
  description  String
  status       TicketStatus      @default(open)
  priority     TicketPriority    @default(normal)
  category     TicketCategory    @default(other)
  resolvedAt   DateTime?
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  user         user              @relation("ticket_user", fields: [userId], references: [id], onDelete: Cascade)
  assignedTo   user?             @relation("ticket_assigned", fields: [assignedToId], references: [id], onDelete: SetNull)
  replies      ticket_reply[]
  activities   ticket_activity[]

  @@index([userId])
  @@index([assignedToId])
  @@index([status])
  @@index([priority])
  @@index([category])
  @@index([createdAt])
}

model ticket_activity {
  id        String             @id @default(cuid())
  ticketId  String
  userId    String
  type      TicketActivityType
  content   String?            @db.Text
  metadata  Json?
  createdAt DateTime           @default(now())
  ticket    ticket             @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user      user               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([userId])
  @@index([createdAt])
}

model ticket_reply {
  id        String   @id @default(cuid())
  ticketId  String
  userId    String
  content   String
  createdAt DateTime @default(now())
  ticket    ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user      user     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([userId])
  @@index([createdAt])
}

// ==========================================
// BILLING & SUBSCRIPTIONS
// ==========================================

model referral {
  id             String         @id @default(cuid())
  affiliateId    String
  referredUserId String         @unique
  status         ReferralStatus @default(pending)
  commission     Decimal        @default(0) @db.Decimal(10, 2)
  convertedAt    DateTime?
  paidAt         DateTime?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  affiliate      affiliate      @relation(fields: [affiliateId], references: [id], onDelete: Cascade)
  user           user           @relation(fields: [referredUserId], references: [id], onDelete: Cascade)

  financial_transaction financial_transaction[]

  @@index([affiliateId])
  @@index([status])
}

// ==========================================
// FINANCIAL LEDGER SYSTEM
// ==========================================

model financial_category {
  id          String        @id @default(cuid())
  name        String        @unique // Unique identifier (slug)
  label       String // Display name
  type        FinancialType // income | expense
  group       String // Grouping (affiliates, infrastructure, ai, etc.)
  description String? // Optional description
  sortOrder   Int           @default(0)
  isActive    Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  transactions financial_transaction[]

  @@index([type])
  @@index([group])
  @@index([isActive])
}

model financial_transaction {
  id          String        @id @default(cuid())
  categoryId  String
  type        FinancialType // Denormalized for fast queries
  amount      Decimal       @db.Decimal(10, 4) // 4 decimals for small costs
  currency    String        @default("USD")
  description String

  // Optional references
  userId      String? // Related user
  affiliateId String? // Related affiliate
  referralId  String? // Related referral

  // For unit costs (AI)
  unitType  String? // "message", "image", "video", "audio"
  unitCount Int? // Quantity
  unitCost  Decimal? @db.Decimal(10, 6) // Cost per unit

  // Metadata
  externalId String? // External ID (invoice, etc.)
  provider   String? // "runpod", "vercel", "prisma", etc.
  metadata   Json?
  notes      String?

  // Period (for monthly expenses)
  periodStart DateTime?
  periodEnd   DateTime?

  createdAt DateTime @default(now())
  createdBy String? // Admin who created

  // Relations
  category  financial_category @relation(fields: [categoryId], references: [id])
  user      user?              @relation(fields: [userId], references: [id])
  affiliate affiliate?         @relation(fields: [affiliateId], references: [id])
  referral  referral?          @relation(fields: [referralId], references: [id])

  @@index([categoryId])
  @@index([type])
  @@index([userId])
  @@index([affiliateId])
  @@index([provider])
  @@index([createdAt])
}

model session {
  id        String   @id @default(cuid())
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      user     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model subscription {
  id                 String             @id @default(cuid())
  userId             String             @unique
  billingCycle       BillingCycle
  status             SubscriptionStatus
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  coinGateOrderId    String?
  cancelledAt        DateTime?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  user               user               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([coinGateOrderId])
  @@index([currentPeriodEnd])
  @@index([status])
}

model token_transaction {
  id              String               @id @default(cuid())
  userId          String
  amount          Int                  // Positive = credit, Negative = debit
  transactionType TokenTransactionType
  description     String?              // Optional details (e.g., "Generated 2 images")
  balanceAfter    Int                  // Balance after this transaction (audit trail)
  metadata        Json?                // Optional: store extra data (imageIds, chatId, etc.)
  createdAt       DateTime             @default(now())
  user            user                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([transactionType])
  @@index([createdAt])
}

// ==========================================
// ROLE MODEL
// ==========================================

model role_custom {
  id          String       @id @default(cuid())
  name        String       @unique
  permissions Json
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  users       user[]       @relation("UserCustomRole")
  invitations invitation[]
}

// ==========================================
// USER MODEL
// ==========================================

model user {
  id                    String                  @id @default(cuid())
  name                  String
  email                 String                  @unique
  emailVerified         Boolean                 @default(false)
  image                 String?
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @default(now()) @updatedAt
  avatar                String?
  nickname              String?
  gender                String?
  language              Language                @default(english)
  notifications         Boolean                 @default(true)
  customRoleId          String?
  tokenBalance          Int                     @default(0)
  customRole            role_custom?            @relation("UserCustomRole", fields: [customRoleId], references: [id])
  Post                  Post[]
  account               account[]
  affiliate             affiliate?
  character             character[]
  character_image       character_image[]
  chat                  chat[]
  collection            collection[]
  referral              referral?
  session               session[]
  subscription          subscription?
  token_transaction     token_transaction[]
  financial_transaction financial_transaction[]
  media_folder          media_folder[]
  visual_novel          visual_novel[]
  tickets_created       ticket[]                @relation("ticket_user")
  tickets_assigned      ticket[]                @relation("ticket_assigned")
  ticket_reply          ticket_reply[]
  ticket_activity       ticket_activity[]
  invitations_created   invitation[]            @relation("invitation_creator")

  @@index([language])
  @@index([customRoleId])
}

// ==========================================
// INVITATION MODEL
// ==========================================

model invitation {
  id        String      @id @default(cuid())
  email     String
  roleId    String
  token     String      @unique
  usedAt    DateTime?
  createdBy String
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  role      role_custom @relation(fields: [roleId], references: [id])
  creator   user        @relation("invitation_creator", fields: [createdBy], references: [id])

  @@index([token])
  @@index([email])
  @@index([roleId])
}

model verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt
}

// ==========================================
// ENUMS
// ==========================================

enum BillingCycle {
  monthly
  quarterly
  annually
}

enum Language {
  english
  german
  french
  spanish
}

enum MediaType {
  image
  video
}

enum MediaCategory {
  scenery
  character_image
  audio
  other
}

enum MessageType {
  text
  image
  video
  audio
}

enum ReferralStatus {
  pending
  converted
  paid
}

enum SubscriptionStatus {
  active
  cancelled
  expired
  pending
}

enum VisualNovelNodeType {
  scene
  choice
  condition
  start
  end
}

enum TicketStatus {
  open
  in_progress
  resolved
  closed
}

enum TicketPriority {
  low
  normal
  high
  urgent
}

enum TicketCategory {
  billing
  technical
  account
  content
  other
}

enum TicketActivityType {
  note
  status_change
  priority_change
  assigned
  created
}

enum TokenTransactionType {
  subscription_renewal
  purchase
  image_generation
  chat_message
  voice_message
  video_generation
  private_content_unlock
  refund
  admin_adjustment
  promotional
}

enum FinancialType {
  income
  expense
}
